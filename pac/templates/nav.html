{% load static %}
<nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow-sm">
    <div class="container-fluid">
        <a class="navbar-brand d-flex align-items-center" href="{{ back_url }}">
            <img src="{% static 'image/logo-pac.png' %}" width="40" class="me-2">
            <span class="fw-bold">PAC Public</span>
        </a>
        
        <div class="ms-auto">
            <div class="dropdown">
                <a href="#" class="d-flex align-items-center text-decoration-none dropdown-toggle user-dropdown" 
                   role="button" data-bs-toggle="dropdown" aria-expanded="false" id="profileDropdown">
                    <div class="text-end me-2 d-none d-sm-block">
                        <small class="d-block text-light opacity-75" style="font-size: 0.75rem;">Bienvenue,</small>
                        <span class="text-white fw-medium" style="font-size: 0.9rem;">{{ user.nom }}</span>
                    </div>
                    <img src="{% if user.photo %}{{ user.photo.url }}{% else %}{% static 'image/profile.png' %}{% endif %}" 
                         width="42" height="42" class="rounded-circle border border-2 border-primary shadow-sm">
                </a>

                <ul class="dropdown-menu dropdown-menu-end shadow border-0 p-2 mt-2" aria-labelledby="profileDropdown" style="min-width: 240px; border-radius: 12px;">
                    <li class="p-3 bg-light rounded-3 mb-2">
                        <div class="d-flex align-items-center">
                            <img src="{% if user.photo %}{{ user.photo.url }}{% else %}{% static 'image/profile.png' %}{% endif %}" 
                                 width="45" height="45" class="rounded-circle me-3 shadow-sm">
                            <div class="overflow-hidden">
                                <h6 class="mb-0 text-dark fw-bold text-truncate">{{ user.nom }} {{ user.prenom }}</h6>
                                <p class="mb-0 text-muted small text-truncate" style="font-size: 0.8rem;">{{ user.email }}</p>
                            </div>
                        </div>
                    </li>
                    
                    <li>
                        <a class="dropdown-item rounded-2 py-2" href="#" data-bs-toggle="modal" data-bs-target="#profileModal">
                            <i class="bi bi-person-gear me-2 text-primary"></i> Mon Profil
                        </a>
                    </li>
                   
                    
                    <li><hr class="dropdown-divider opacity-50"></li>
                    
                    <li>
                        <a class="dropdown-item rounded-2 py-2 text-danger" href="{% url 'utilisateur:api_logout' %}">
                            <i class="bi bi-box-arrow-right me-2"></i> Se Déconnecter
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</nav>

<div class="modal fade" id="profileModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Modifier mon profil</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="profileUpdateForm" enctype="multipart/form-data">
                <div class="modal-body">
                    <div class="text-center mb-3">
                        <img id="previewPhoto" src="{% if user.photo %}{{ user.photo.url }}{% else %}{% static 'image/profile.png' %}{% endif %}" 
                             width="100" height="100" class="rounded-circle mb-2">
                        <input type="file" name="photo" class="form-control form-control-sm" accept="image/*" onchange="previewImage(this)">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Nom</label>
                        <input type="text" name="nom" class="form-control" value="{{ user.nom }}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Prénom</label>
                        <input type="text" name="prenom" class="form-control" value="{{ user.prenom }}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Téléphone</label>
                        <input type="text" name="telephone" class="form-control" value="{{ user.telephone|default:'' }}">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                    <button type="submit" class="btn btn-primary">Enregistrer les modifications</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Prévisualisation de l'image
function previewImage(input) {
    if (input.files && input.files[0]) {
        var reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('previewPhoto').src = e.target.result;
        }
        reader.readAsDataURL(input.files[0]);
    }
}

// Soumission du formulaire via API
document.getElementById('profileUpdateForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const submitBtn = this.querySelector('button[type="submit"]');
    
    
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Chargement...';

    fetch("{% url 'utilisateur:update_profil' %}", {  
        method: 'POST', 
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'X-HTTP-Method-Override': 'PUT' // Optionnel : informe REST framework que c'est un PUT
        },
        body: formData
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => { throw err; });
        }
        return response.json();
    })
    .then(data => {
        Swal.fire({
            icon: 'success',
            title: 'Mis à jour !',
            text: 'Votre profil a été modifié avec succès.',
            timer: 1500,
            showConfirmButton: false
        }).then(() => {
            location.reload(); 
        });
    })
    .catch(error => {
        console.error('Erreur:', error);
        let errorMsg = "Une erreur est survenue.";
        if (error) {
            // Transforme les erreurs du serializer en texte lisible
            errorMsg = Object.values(error).flat().join("<br>");
        }
        Swal.fire('Erreur', errorMsg, 'error');
    })
    .finally(() => {
        submitBtn.disabled = false;
        submitBtn.innerHTML = 'Enregistrer les modifications';
    });
});



</script>