{% extends "base.html" %}
{% load static %}
{% load my_custom_tags %}
{% block title %} PAC Public {% endblock title%}

{% block content %}
{% include "nav.html" %}
<style>
.main-content {
        margin-left: 0 !important; /* On force le retrait de la marge pour les visiteurs */
    }
</style>
<div class="container mt-4">

    {# --- Messages de succÃ¨s/erreur Django --- #}
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} mt-3" role="alert">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}

    {# ======================================================= #}
    {# MODE FORMULAIRE (AJOUT / MODIFICATION) #}
    {# ======================================================= #}
    {% if mode == 'form' %}
        {% include "pac/plainte.html" %}
    {% else %}
    
    {# ======================================================= #}
    {# MODE LISTE (LISTE / DÃ‰TAILS) #}
    {# ======================================================= #}
        
        <h2 class="mt-3">ðŸ‘‹ Tongasoa, {{ user.nom|default:"Utilisateur" }}!</h2>
        <hr>

        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3>ðŸ“‹ Liste des plaintes</h3>
            <a href="{% url 'pac:public' %}?mode=form" class="btn btn-success btn-lg">
                <i class="bi bi-plus-circle-fill"></i> Ametraka fitoriana vaovao
            </a>
        </div>

        {# --- BLOC D'AFFICHAGE DES DÃ‰TAILS (NON TABULAIRE) --- #}
        {% if plainte_detail %}
           {% include "pac/detail_plainte.html" %}
        {% endif %}
        {# --- FIN DU BLOC D'AFFICHAGE DES DÃ‰TAILS --- #}


        {% if plaintes %}
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>NÂ° Chrono TKK</th>
                            <th>Date</th>
                            <th>Auteur prÃ©sumÃ©</th>
                            <th>Statut</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for plainte in plaintes %}
                        <tr>
                            <td class="fw-bold">{{ plainte.n_chrono_tkk }}</td>
                            <td>{{ plainte.date_plainte }}</td>
                            <td>{{ plainte.ilay_olona_kolikoly|truncatechars:50 }}</td>
                            <td>
                                {% if plainte.statut == 'ATTENTE' %}
                                    <span class="badge bg-warning text-dark">{{ plainte.statut }}</span>
                                {% elif plainte.statut == 'COURS' %}
                                    <span class="badge bg-info text-dark">{{ plainte.statut }}</span>
                                {% elif plainte.statut == 'TRAITEE' %}
                                    <span class="badge bg-success">{{ plainte.statut }}</span>
                                {% elif plainte.statut == 'DISPATCHE' %}
                                    <span class="badge bg-success">{{ plainte.statut }}</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if plainte.statut != 'ATTENTE' %}
                                {# Bouton DÃ‰TAILS (Mode liste + detail_id) #}
                               <a href="{% url 'pac:public' %}?mode=list&detail_id={{ plainte.id }}" class="btn btn-sm btn-info me-1" title="Voir les dÃ©tails">
                                   <i class="bi bi-eye-fill"></i>
                               </a>
                               {% else %}
                               <a href="{% url 'pac:public' %}?mode=list&detail_id={{ plainte.id }}" class="btn btn-sm btn-info me-1" title="Voir les dÃ©tails">
                                   <i class="bi bi-eye-fill"></i>
                               </a>
                               
                               {# Bouton MODIFIER (Mode form + plainte_id) #}
                               <a href="{% url 'pac:public' %}?mode=form&plainte_id={{ plainte.id }}" class="btn btn-sm btn-success me-1" title="Modifier">
                                   <i class="bi bi-pencil-fill"></i>
                               </a>

                               {# Bouton SUPPRIMER (Formulaire POST pour Swal) #}
                               <form method="POST" class="d-inline form-delete" data-id="{{ plainte.id }}">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-sm btn-danger" title="Supprimer"> 
                                        <i class="bi bi-trash-fill"></i>
                                    </button>
                                </form>
                               {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="alert alert-info" role="alert">
                Vous n'avez pas encore dÃ©posÃ© de plainte. Cliquez sur le bouton vert "Ametraka fitoriana vaovao" pour commencer.
            </div>
        {% endif %}

    {% endif %}

</div>

{% if request.session.plainte_success %}
        {% with success_data=request.session.plainte_success %}
        {% include "qr.html" %}
        {% endwith %}
        {% delete_session_key 'plainte_success' %}
{% endif %}
{% block extra_js %}
{# 1. Charger jQuery en premier (si non prÃ©sent dans base.html) #}
    <script src="{% static 'js/jquery-3.7.1.min.js'%}"></script>
    
    {# --- 1. Inclusion de SweetAlert2 (Ã  placer dans votre base.html ou ici) --- #}
    <script src="{% static 'js/sweetalert211.js' %}"></script>
    <script>
        $(document).ready(function() {
            
            // Cible tous les formulaires ayant la classe 'form-delete'
           $(document).on('submit', '.form-delete', function(e) {
                e.preventDefault(); 
                var form = this;
                var plainteId = $(form).data('id'); // RÃ©cupÃ¨re l'ID depuis data-id

                Swal.fire({
                    title: 'ÃŠtes-vous sÃ»r ?',
                    text: "Cette action est irrÃ©versible.",
                    icon: 'warning', 
                    showCancelButton: true, 
                    confirmButtonText: 'Oui, Supprimer !'
                }).then((result) => {
                    if (result.isConfirmed) {
                        $.ajax({
                            // On construit l'URL dynamiquement avec l'ID
                            url: "/api/public/plaintes/" + plainteId + "/", 
                            type: "DELETE",
                            headers: { "X-CSRFToken": "{{ csrf_token }}" },
                            success: function(response) {
                                Swal.fire('SuccÃ¨s !', response.detail, 'success').then(() => {
                                    window.location.href = "{% url 'pac:public' %}?mode=list";
                                });
                            },
                            error: function(xhr) {
                                Swal.fire('Erreur', "Impossible de supprimer la plainte.", 'error');
                            }
                        });
                    }
                });
            });
        });
    </script>
<script>
$(document).ready(function() {
    // Utilisation de .off() avant .on() pour s'assurer qu'un seul Ã©couteur est attachÃ©
    $(document).off('submit', '#plainteForm').on('submit', '#plainteForm', function(e) {
        e.preventDefault();
        
        var $form = $(this);
        var $submitBtn = $form.find('.btn-envoyer');
        var formData = new FormData(this);
        
        // RÃ©cupÃ©ration de l'ID via l'URL ou le champ cachÃ©
        const urlParams = new URLSearchParams(window.location.search);
        const pId = urlParams.get('plainte_id') || $form.find('input[name="plainte_id"]').val();
        
        // DÃ©sactiver le bouton pour Ã©viter les clics frÃ©nÃ©tiques
        $submitBtn.prop('disabled', true);

        Swal.fire({ 
            title: 'Chargement...', 
            allowOutsideClick: false, 
            didOpen: () => Swal.showLoading() 
        });

        $.ajax({
            url: pId ? "{% url 'pac:api_public_plaintes' %}" + pId + "/" : "{% url 'pac:api_public_plaintes' %}",
            type: "POST",
            data: formData,
            processData: false,
            contentType: false,
            headers: { "X-CSRFToken": "{{ csrf_token }}" },
            success: function(response) {
                Swal.fire('SuccÃ¨s !', response.detail, 'success').then(() => {
                    window.location.href = "{% url 'pac:public' %}?mode=list";
                });
            },
            error: function(xhr) {
                $submitBtn.prop('disabled', false); // RÃ©activer en cas d'erreur
                Swal.fire('Erreur', "Une erreur est survenue lors de l'enregistrement.", 'error');
            }
        });
    });
});
</script>
{% endblock extra_js %}
{% endblock content %}

