{% extends "base.html" %}
{% load static %}
{% block title %} Espace OPJ {% endblock title %}

{% block content %}
{% include "nav.html" %}

<div class="container mt-4">
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} mt-3" role="alert">{{ message }}</div>
        {% endfor %}
    {% endif %}

    {% if mode == 'form' %}
        {% include "pac/opj_form.html" %}
    {% else %}
        <h2 class="mt-3">üëã Espace OPJ, {{ user.nom|default:"Utilisateur" }}!</h2>
        <hr>

        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3>üìã Liste des dossiers OPJ</h3>
            <a href="{% url 'pac:opj' %}?mode=form" class="btn btn-primary btn-lg">
                <i class="bi bi-plus-circle-fill"></i> Hametraka dossier vaovao
            </a>
        </div>

        {% if opj_detail %}
           {% include "pac/detail_opj.html" %}
        {% endif %}

        {% if dossiers %}
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>NBE OPJ</th>
                            <th>Date</th>
                            <th>Auteur pr√©sum√©</th>
                            <th>Statut</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in dossiers %}
                        <tr>
                            <td class="fw-bold">{{ item.n_chrono_opj }}</td>
                            <td>{{ item.date_plainte }}</td>
                            <td>{{ item.ilay_olona_kolikoly|truncatechars:50 }}</td>
                            <td>
                                <span class="badge {% if item.statut == 'ATTENTE' %}bg-warning{% else %}bg-info{% endif %}">
                                    {{ item.statut }}
                                </span>
                            </td>
                            <td>
                                <a href="{% url 'pac:opj' %}?mode=list&detail_id={{ item.id }}" class="btn btn-sm btn-info me-1">
                                    <i class="bi bi-eye-fill"></i>
                                </a>
                                {% if item.statut == 'ATTENTE' %}
                                <a href="{% url 'pac:opj' %}?mode=form&opj_id={{ item.id }}" class="btn btn-sm btn-success me-1">
                                    <i class="bi bi-pencil-fill"></i>
                                </a>
                               
                               <button type="button" 
                                        class="btn btn-sm btn-danger delete-btn" 
                                        data-id="{{ item.id }}" 
                                        title="Supprimer"> 
                                    <i class="bi bi-trash-fill"></i>
                                </button>
                              
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="alert alert-info">Aucun dossier enregistr√©.</div>
        {% endif %}
    {% endif %}
</div>


{% block extra_js %}
    {# 1. Chargement des biblioth√®ques #}
    <script src="{% static 'js/jquery-3.7.1.min.js'%}"></script>
    <script src="{% static 'js/sweetalert2@11.js' %}"></script>
    <script>
            document.querySelectorAll('.delete-btn').forEach(button => {
            button.addEventListener('click', function(e) {
                const deleteUrl = this.getAttribute('data-url');
                const itemId = this.getAttribute('data-id');
                const url = `/api/opj/${itemId}/`;
                Swal.fire({
                    title: '√ätes-vous s√ªr ?',
                    text: "Ce dossier OPJ sera d√©finitivement supprim√©.",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'Oui, supprimer !',
                    cancelButtonText: 'Annuler'
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Envoi de la requ√™te DELETE √† l'API
                        fetch(url, {
                            method: 'DELETE',
                            headers: {
                                'X-CSRFToken': getCookie('csrftoken'), // Important pour Django
                                'Content-Type': 'application/json'
                            }
                        })
                        .then(response => {
                            if (response.ok) {
                                Swal.fire(
                                    'Supprim√© !',
                                    'Le dossier a √©t√© supprim√© avec succ√®s.',
                                    'success'
                                ).then(() => {
                                    location.reload(); // Recharge la page pour actualiser la liste
                                });
                            } else {
                                Swal.fire('Erreur', 'Impossible de supprimer ce dossier.', 'error');
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            Swal.fire('Erreur', 'Une erreur r√©seau est survenue.', 'error');
                        });
                    }
                });
            });
        });

        // Fonction utilitaire pour r√©cup√©rer le token CSRF de Django
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>
    <script>
        document.getElementById('opjForm').addEventListener('submit', function(e) {
    e.preventDefault(); // Emp√™che le rechargement classique de la page

    const form = this;
    const formData = new FormData(form); // Capture texte et fichiers (enctype="multipart/form-data")
    const url = "{% url 'pac:api_opj_views' %}";

    // 1. Afficher l'alerte "Traitement en cours"
    Swal.fire({
        title: 'Traitement...',
        text: 'Veuillez patienter pendant l\'enregistrement du dossier.',
        allowOutsideClick: false,
        showConfirmButton: false,
        didOpen: () => {
            Swal.showLoading();
        }
    });

    // 2. Envoi des donn√©es via Fetch
    fetch(url, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            
        }
    })
    .then(response => {
        return response.json().then(data => {
            if (response.ok) {
                // 3. Succ√®s
                Swal.fire({
                    icon: 'success',
                    title: 'Succ√®s !',
                    text: data.detail || 'Plainte envoy√©e avec succ√®s',
                    confirmButtonText: 'OK'
                }).then(() => {
                    // Redirection apr√®s succ√®s (vers la liste des dossiers par exemple)
                    window.location.href = "{% url 'pac:opj' %}";
                });
            } else {
                // 4. Gestion des erreurs (ex: validation serializer)
                let errorMsg = "Veuillez v√©rifier les champs du formulaire.";
                if (typeof data === 'object') {
                    errorMsg = Object.values(data).flat().join('\n');
                }
                Swal.fire({
                    icon: 'error',
                    title: 'Erreur',
                    text: errorMsg
                });
            }
        });
    })
    .catch(error => {
        console.error('Error:', error);
        Swal.fire({
            icon: 'error',
            title: 'Erreur r√©seau',
            text: 'Impossible de joindre le serveur.'
        });
    });
});
    </script>
{% endblock %}
{% endblock content %}

