{% extends "base.html" %}
{% load static %}

{% block title %} DCN {% endblock title %}

{% block content %} 

{% include "nav.html" %}
    
        <div class="top-bar-pac d-flex justify-content-between" style="background-color:rgb(49, 49, 154); color:white; padding: 10px 15px;">
            <div style="margin-left:50px;">
                {{ user.nom }} - {{ user.poste }}
            </div>
            <div>
                PAC {{ user.localite|default:"[Localité]" }}
            </div>
        </div>
        <div class="content-wrapper p-4">
            
            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-success mt-3" role="alert">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
                <div class="d-flex justify-content-between align-items-center mb-3">
                        <h2>{{titre_menu}}</h2>
                    </div>
                {% if menu_active == "arrive"%}
                    <div class="table-responsive mt-3"
                        hx-get="{% url 'pac:dcn' %}?mode=list" 
                        hx-trigger="every 20s" 
                        hx-select="#registre-plainte" 
                        hx-target="#registre-plainte" 
                        hx-swap="outerHTML">
                        {% if po %}
                            
                        {# --- BLOC D'AFFICHAGE DES DÉTAILS (NON TABULAIRE) --- #}
                            {% if plainte_detail %}
                                {% include "pac/detail_plainte.html" %}
                            {% endif %}
                        {# --- FIN DU BLOC D'AFFICHAGE DES DÉTAILS --- #}
                            <div class="table-responsive">
                                <form method="GET" action="{% url 'pac:dcn' %}" class="mb-3 d-flex">
                                    <input type="hidden" name="mode" value="list">
                                    <input type="text" name="search" class="form-control me-2" placeholder="Rechercher un numéro, auteur..." value="{{ search_query }}">
                                    <button type="submit" class="btn btn-primary">Rechercher</button>
                                    {% if search_query %}
                                        <a href="{% url 'pac:dcn' %}" class="btn btn-outline-secondary ms-2">Réinitialiser</a>
                                    {% endif %}
                                </form>
                                <table class="table table-striped table-hover" id="registre-plainte">
                                    <thead class="table-dark">
                                        <tr>
                                            
                                            <th>N° Chrono TKK</th>
                                            <th>Date</th>
                                            <th>Auteur présumé</th>
                                            <th>Nature</th>
                                            <th>Statut</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for p in po %}
                                        <tr>
        
                                            <td class="fw-bold">{{ p.n_chrono_tkk }}</td>
                                            <td>{{ p.date_plainte|date:"d/m/Y" }}</td>
                                            
                                            <td>{{ p.ilay_olona_kolikoly|truncatechars:50 }}</td>
                                            <td>{{ p.tranga_kolikoly|truncatechars:50}}</td>
                                            <td>
                                                {% if p.statut == 'ATTENTE' %}
                                                    <span class="badge bg-warning text-dark">{{ p.get_statut_display }}</span>
                                                {% elif p.statut == 'COURS' %}
                                                    <span class="badge bg-info text-dark">{{ p.get_statut_display }}</span>
                                                {% elif p.statut == 'DISPATCHE' %}
                                                    <span class="badge bg-primary text-dark">{{ p.get_statut_display }}</span>
                                                {% elif p.statut == 'TRAITEE' %}
                                                    <span class="badge bg-success">{{ p.get_statut_display }}</span>
                            
                                                {% elif p.statut == 'CSS' %}
                                                    <span class="badge bg-danger">{{ p.get_statut_display }}</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <a href="{% url 'pac:dcn' %}?mode=list&detail_id={{ p.pk }}" class="btn btn-sm btn-info me-1" title="Voir les détails">
                                    <i class="bi bi-eye-fill"></i>
                                                </a>
                                                {% if p.statut != 'ATTENTE' %}

                                                {% else %}
                                                <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#dispatch-{{ p.pk }}" title="dispatch"> DISPATCH </button>
                                                
                                                <div class="modal fade" id="dispatch-{{ p.pk }}" tabindex="-1" aria-labelledby="dispatchModalLabel-{{ p.pk }}" aria-hidden="true">
                                                    <div class="modal-dialog modal-dialog-centered">
                                                        <div class="modal-content border-0 shadow-lg">
                                                            <div class="modal-header bg-primary text-white">
                                                                <h5 class="modal-title d-flex align-items-center" id="dispatchModalLabel-{{ p.pk }}">
                                                                    <i class="bi bi-send-exclamation-fill me-2"></i> 
                                                                    Dispatcher la plainte
                                                                </h5>
                                                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                                                            </div>

                                                            <form method="POST" action="{% url 'pac:dcn' %}?mode=dispatch">
                                                                {% csrf_token %}
                                                                <div class="modal-body p-4">
                                                                    <div class="alert alert-info border-0 shadow-sm d-flex align-items-center mb-4">
                                                                        <i class="bi bi-info-circle-fill fs-4 me-3"></i>
                                                                        <div>
                                                                            <small class="d-block text-uppercase fw-bold opacity-75">Dossier N°</small>
                                                                            <span class="fw-bold">{{ p.n_chrono_tkk }}</span>
                                                                        </div>
                                                                    </div>

                                                                    <input type="hidden" name="idplainte" value="{{p.pk}}">

                                                                    <div class="form-group">
                                                                        <label for="pac_select_{{ p.pk }}" class="form-label fw-bold">
                                                                            Choisir la destination (PAC)
                                                                        </label>
                                                                        <div class="input-group">
                                                                            <span class="input-group-text bg-white"><i class="bi bi-geo-alt"></i></span>
                                                                            <select name="pac" id="pac_select_{{ p.pk }}" class="form-select form-select-lg border-start-0" required>
                                                                                <option value="" selected disabled>Sélectionner un siège...</option>
                                                                                <option value="ANTANANARIVO">PAC ANTANANARIVO</option>
                                                                                <option value="FIANARANTSOA">PAC FIANARANTSOA</option>
                                                                                <option value="MAHAJANGA">PAC MAHAJANGA</option>
                                                                            </select>
                                                                        </div>
                                                                        <p class="form-text mt-2 small text-muted">
                                                                            Cette action transmettra officiellement le dossier au siège sélectionné.
                                                                        </p>
                                                                    </div>
                                                                </div>

                                                                <div class="modal-footer bg-light border-top-0">
                                                                    <button type="button" class="btn btn-outline-secondary px-4" data-bs-dismiss="modal">Annuler</button>
                                                                    <button type="submit" class="btn btn-primary px-4 shadow-sm">
                                                                        <i class="bi bi-check2-circle me-1"></i> Confirmer l'envoi
                                                                    </button>
                                                                </div>
                                                            </form>
                                                        </div>
                                                    </div>
                                                </div>
                                                {% endif %}
                                            
                                                </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                                <nav aria-label="Page navigation">
                                    <ul class="pagination justify-content-center">
                                        {% if po.has_previous %}
                                        <li class="page-item"><a class="page-link" href="?page=1&search={{ search_query }}&mode={{ menu_active }}">&laquo; Début</a></li>
                                        <li class="page-item"><a class="page-link" href="?page={{ po.previous_page_number }}&search={{ search_query }}&mode={{ menu_active }}">Précédent</a></li>
                                        {% endif %}

                                        <li class="page-item disabled"><span class="page-link">Page {{ po.number }} sur {{ po.paginator.num_pages }}</span></li>

                                        {% if po.has_next %}
                                        <li class="page-item"><a class="page-link" href="?page={{ po.next_page_number }}&search={{ search_query }}&mode={{ menu_active }}">Suivant</a></li>
                                        <li class="page-item"><a class="page-link" href="?page={{ po.paginator.num_pages }}&search={{ search_query }}&mode={{ menu_active }}">Fin &raquo;</a></li>
                                        {% endif %}
                                    </ul>
                                </nav>
                            </div>
                        {% else %}
                            <div class="alert alert-info">Aucun plainte n'a été trouvé.</div>
                        {% endif %}
                    </div>
                {% elif menu_active == "trib" %}
                    <div class="table-responsive mt-3">
                        <table class="table table-bordered table-hover shadow-sm align-middle">
                            <thead class="table-dark">
                                <tr>
                                    <th><i class="bi bi-geo-alt-fill me-2"></i>Tribunal (PAC)</th>
                                    <th class="text-center">Total Reçus (Entrées)</th>
                                    <th class="text-center">En cours de traitement</th>
                                    <th class="text-center">Total Traitées (Sorties)</th>
                                    <th class="text-center">CSS</th> 
                                    <th class="text-center">Taux de performance</th>
                                    <th class="text-center">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for stat in stats_tribunaux %}
                                <tr>
                                    <td class="fw-bold text-primary">{{ stat.nom }}</td>
                                    <td class="text-center">
                                        <span class="badge bg-primary rounded-pill">{{ stat.nb_entree }}</span>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge bg-warning text-dark rounded-pill">{{ stat.nb_en_cours }}</span>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge bg-success rounded-pill">{{ stat.nb_sortie }}</span>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge bg-secondary rounded-pill">{{ stat.nb_css }}</span>
                                    </td>
                                    <td style="width: 20%;">
                                        {% if stat.nb_entree > 0 %}
                                            {% with total_clos=stat.nb_sortie|add:stat.nb_css %}
                                            <div class="progress" style="height: 18px;" title="Dossiers clos (Traités + CSS)">
                                                <div class="progress-bar bg-success" role="progressbar" 
                                                    style="width: {% widthratio stat.nb_sortie stat.nb_entree 100 %}%">
                                                </div>
                                                <div class="progress-bar bg-secondary" role="progressbar" 
                                                    style="width: {% widthratio stat.nb_css stat.nb_entree 100 %}%">
                                                </div>
                                            </div>
                                            <small class="text-muted d-block text-center mt-1">
                                                {% widthratio total_clos stat.nb_entree 100 %}% clos
                                            </small>
                                            {% endwith %}
                                        {% else %}
                                            <div class="text-center"><small>-</small></div>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        <div class="btn-group">
                                            <a href="{% url 'pac:dcn' %}?mode=list&tribunal={{ stat.code }}" 
                                            class="btn btn-sm btn-outline-info" title="Toutes les plaintes">
                                                <i class="bi bi-eye"></i>
                                            </a>
                                            <a href="{% url 'pac:dcn' %}?mode=list&tribunal={{ stat.code }}&statut=CSS" 
                                            class="btn btn-sm btn-outline-secondary" title="Voir uniquement les CSS">
                                                <i class="bi bi-archive"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% elif menu_active == "stat" %}
                    {% include 'pac/stat.html'%}
                {% endif %}

            

        </div>


{% block extra_js %}
    {{ block.super }}
    
    <script src="{% static 'js/jquery-3.6.0.min.js'%}"></script> 
    <script type="text/javascript" charset="utf8" src="{% static 'js/dataTables.min.js'%}"></script>
    <script>
       
    function initDataTable() {
        if ($.fn.DataTable.isDataTable('#registre-plainte')) {
            $('#registre-plainte').DataTable().destroy();
        }

        $('#registre-plainte').DataTable({
            "paging": false,
            "searching": false,
            "info": false,
            "ordering": true,
            "language": {
                "sEmptyTable":     "Aucune donnée disponible dans le tableau",
                "sInfo":           "Affichage de l'élément _START_ à _END_ sur _TOTAL_ éléments",
                "sInfoEmpty":      "Affichage de l'élément 0 à 0 sur 0 élément",
                "sInfoFiltered":   "(filtré à partir de _MAX_ éléments au total)",
                "sLengthMenu":     "Afficher _MENU_ éléments",
                "sLoadingRecords": "Chargement...",
                "sProcessing":     "Traitement...",
                "sSearch":         "Rechercher :",
                "sZeroRecords":    "Aucun élément correspondant trouvé",
                "oPaginate": {
                    "sFirst":    "Premier",
                    "sLast":     "Dernier",
                    "sNext":     "Suivant",
                    "sPrevious": "Précédent"
                },
                "oAria": {
                    "sSortAscending":  ": activer pour trier la colonne par ordre croissant",
                    "sSortDescending": ": activer pour trier la colonne par ordre décroissant"
                }
            }
        });
    }

    $(document).ready(function() {
        initDataTable();
    });

    document.body.addEventListener('htmx:afterSwap', function(evt) {
        // Correction : on vérifie si le swap concerne le conteneur du tableau
        if (evt.detail.target.id === "registre-plainte" || $(evt.detail.target).find('#registre-plainte').length > 0) {
            initDataTable();
        }
    });
</script>

{% endblock extra_js %}
{% endblock content %}