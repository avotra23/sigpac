{% extends "base.html" %}
{% load static %}
{% load my_custom_tags %}
{% block title %} PAC Public {% endblock title%}

{% block content %}
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="{% url 'public' %}"> <img src="{% static 'image/logo-pac.png'%}" width="50">PAC Public</a>
        
        <div class="ms-auto">
            <div class="dropdown">
                <a href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false" id="profileDropdown">
                   <img src="{% static 'image/profile.png'%}" width="50"> </a>

                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="profileDropdown">
                    <li class="px-3 py-2 text-wrap" style="max-width: 250px;">
                        <p class="mb-0 text-dark fw-bold">
                            {{ user.nom|default:"Utilisateur" }}
                        </p>
                        <small class="text-muted">
                            {{ user.email|default:"Email non disponible" }}
                        </small>
                    </li>
                    
                    <li><hr class="dropdown-divider"></li>
                    
                    <li>
                        <a class="dropdown-item text-danger" href="{% url 'logout' %}">
                            <i class="fas fa-sign-out-alt me-1"></i> Se D√©connecter
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</nav>

<div class="container mt-4">

    {# --- Messages de succ√®s/erreur Django --- #}
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} mt-3" role="alert">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}

    {# ======================================================= #}
    {# MODE FORMULAIRE (AJOUT / MODIFICATION) #}
    {# ======================================================= #}
    {% if mode == 'form' %}
        
        <div class="plainte-container my-5 p-4 border rounded shadow-lg">
            <div class="plainte-header text-center mb-4">
                <h2>{{ form_title|default:"D√âCLARATION PLAINTRE EN LIGNE" }}</h2>
                <span class="fw-bold text-danger fs-5">POLE ANTI-CORRUPTION</span>
            </div>
            
            <form method="post" enctype="multipart/form-data">
                {% csrf_token %}

                <div class="row mb-4">
                    <div class="col-md-6">
                        <label for="n_chrono_tkk" class="form-label">N¬∞ Chrono TKK</label>
                        <input type="text" class="form-control" id="n_chrono_tkk" value="{{ n_chrono_tkk }}" readonly>
                    </div>
                    <div class="col-md-6">
                        <label for="date_plainte" class="form-label">Dates</label>
                        <input type="text" class="form-control" id="date_plainte" value="{{ date_plainte }}" readonly>
                    </div>
                </div>

                <div class="mb-4">
                    <label for="{{ form.ny_mpitory.id_for_label }}" class="section-label fw-bold">{{ form.ny_mpitory.label }}</label>
                    {{ form.ny_mpitory }}
                    {% for error in form.ny_mpitory.errors %}<div class="text-danger small">{{ error }}</div>{% endfor %}
                </div>
                <div class="mb-4">
                    <label for="{{ form.tranga_kolikoly.id_for_label }}" class="section-label fw-bold">{{ form.tranga_kolikoly.label }}</label>
                    {{ form.tranga_kolikoly }}
                    {% for error in form.tranga_kolikoly.errors %}<div class="text-danger small">{{ error }}</div>{% endfor %}
                </div>
                
                <div class="row mb-4">
                    <div class="col-md-6">
                        <label for="{{ form.ilay_olona_kolikoly.id_for_label }}" class="section-label fw-bold">{{ form.ilay_olona_kolikoly.label }}</label>
                        {{ form.ilay_olona_kolikoly }}
                        {% for error in form.ilay_olona_kolikoly.errors %}<div class="text-danger small">{{ error }}</div>{% endfor %}
                    </div>
                    <div class="col-md-6">
                        <label for="{{ form.toorna_birao.id_for_label }}" class="section-label fw-bold">{{ form.toorna_birao.label }}</label>
                        {{ form.toorna_birao }}
                        {% for error in form.toorna_birao.errors %}<div class="text-danger small">{{ error }}</div>{% endfor %}
                    </div>
                </div>
                <div class="mb-4">
                    <label for="{{ form.piece_jointe.id_for_label }}" class="section-label fw-bold">{{ form.piece_jointe.label }}</label>
                    {{ form.piece_jointe }}
                    {% for error in form.piece_jointe.errors %}<div class="text-danger small">{{ error }}</div>{% endfor %}
                    {% if form.instance.piece_jointe %}
                        <p class="mt-2">Fichier actuel: <a class="form-control" href="{{ form.instance.piece_jointe.url }}" target="_blank">{{ form.instance.piece_jointe.name|default:"Aucun" }}</a>. <span class="text-muted">(T√©l√©verser un nouveau fichier remplacera l'ancien)</span></p>
                    {% endif %}
                </div>

                <div class="text-end">
                    <a href="{% url 'public' %}?mode=list" class="btn btn-secondary btn-lg me-2">Annuler</a>
                    <button type="submit" class="btn btn-primary btn-lg btn-envoyer">
                        <i class="bi bi-send-fill"></i> Enregistrer
                    </button>
                </div>
            </form>
        </div>

    {% else %}
    
    {# ======================================================= #}
    {# MODE LISTE (LISTE / D√âTAILS) #}
    {# ======================================================= #}
        
        <h2 class="mt-3">üëã Tongasoa, {{ user.nom|default:"Utilisateur" }}!</h2>
        <hr>

        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3>üìã Liste des plaintes</h3>
            <a href="{% url 'public' %}?mode=form" class="btn btn-success btn-lg">
                <i class="bi bi-plus-circle-fill"></i> Ametraka fitoriana vaovao
            </a>
        </div>

        {# --- BLOC D'AFFICHAGE DES D√âTAILS (NON TABULAIRE) --- #}
        {% if plainte_detail %}
        <div class="card mb-4 border-info shadow-sm">
            <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                <h4 class="mb-0">D√©tails de la Plainte N¬∞ {{ plainte_detail.n_chrono_tkk }}</h4>
                <a href="{% url 'public' %}?mode=list" class="btn btn-sm btn-light">
                    <i class="bi bi-x-lg"></i> Fermer les d√©tails
                </a>
            </div>
            <div class="card-body">
                <div class="row">
                    {# Section A : Informations Chronologiques #}
                    <div class="col-md-6 mb-3">
                        <p class="mb-1"><strong><i class="bi bi-calendar-event me-2"></i> Date de la plainte :</strong> {{ plainte_detail.date_plainte }}</p>
                        <p class="mb-1"><strong><i class="bi bi-tag me-2"></i> N¬∞ Chrono TKK :</strong> <span class="badge bg-primary fs-6">{{ plainte_detail.n_chrono_tkk }}</span></p>
                        <p class="mb-1"><strong><i class="bi bi-info-circle me-2"></i> Statut actuel :</strong> 
                            {% if plainte_detail.statut == 'ATTENTE' %}<span class="badge bg-warning text-dark">{{ plainte_detail.get_statut_display }}</span>
                            {% elif plainte_detail.statut == 'COURS' %}<span class="badge bg-info text-dark">{{ plainte_detail.get_statut_display }}</span>
                            {% elif plainte_detail.statut == 'TRAITEE' %}<span class="badge bg-success">{{ plainte_detail.get_statut_display }}</span>
                            {% endif %}
                        </p>
                    </div>
                    
                    {# Section B : Informations sur la Corruption #}
                    <div class="col-md-6 mb-3">
                        <p class="mb-1"><strong><i class="bi bi-person-fill me-2"></i> Type de plaignant :</strong> {{ plainte_detail.ny_mpitory }}</p>
                        <p class="mb-1"><strong><i class="bi bi-briefcase me-2"></i> Auteur/Bureau pr√©sum√© :</strong> {{ plainte_detail.ilay_olona_kolikoly }}</p>
                        <p class="mb-1"><strong><i class="bi bi-geo-alt-fill me-2"></i> Localisation/Bureau :</strong> {{ plainte_detail.toorna_birao }}</p>
                        <p class="mb-1"><strong><i class="bi bi-exclamation-triangle-fill me-2"></i> Type de corruption :</strong> {{ plainte_detail.tranga_kolikoly }}</p>
                    </div>
                </div>

                {# Section C : Piece jointe #}
                <div class="mt-3 p-3 border rounded bg-light">
                        <h5 class="fw-bold"><i class="bi bi-file-text me-2"></i> Pi√®ce jointe :</h5>
                        
                        {# V√©rifiez si une pi√®ce jointe existe r√©ellement (le champ n'est pas vide) #}
                        {% if plainte_detail.piece_jointe %}
                            <p class="text-justify">
                                <a class="btn btn-outline-secondary" href="{{ plainte_detail.piece_jointe.url }}" target="_blank" rel="noopener noreferrer">
                                    {# Affiche le nom du fichier pour que l'utilisateur clique dessus #}
                                  Voir la piece &nbsp; <img src="{% static 'image/file.png'%}" width="20">
                                </a>
                            </p>
                        {% else %}
                            <p class="text-justify">[Aucune pi√®ce jointe]</p>
                        {% endif %}
                        
                    </div>
            </div>
        </div>
        {% endif %}
        {# --- FIN DU BLOC D'AFFICHAGE DES D√âTAILS --- #}


        {% if plaintes %}
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>N¬∞ Chrono TKK</th>
                            <th>Date</th>
                            <th>Auteur pr√©sum√©</th>
                            <th>Statut</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for plainte in plaintes %}
                        <tr>
                            <td class="fw-bold">{{ plainte.n_chrono_tkk }}</td>
                            <td>{{ plainte.date_plainte|date:"d/m/Y" }}</td>
                            <td>{{ plainte.ilay_olona_kolikoly|truncatechars:50 }}</td>
                            <td>
                                {% if plainte.statut == 'ATTENTE' %}
                                    <span class="badge bg-warning text-dark">{{ plainte.get_statut_display }}</span>
                                {% elif plainte.statut == 'COURS' %}
                                    <span class="badge bg-info text-dark">{{ plainte.get_statut_display }}</span>
                                {% elif plainte.statut == 'TRAITEE' %}
                                    <span class="badge bg-success">{{ plainte.get_statut_display }}</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if plainte.statut == 'COURS' %}
                                {# Bouton D√âTAILS (Mode liste + detail_id) #}
                               <a href="{% url 'public' %}?mode=list&detail_id={{ plainte.id }}" class="btn btn-sm btn-info me-1" title="Voir les d√©tails">
                                   <i class="bi bi-eye-fill"></i>
                               </a>
                               {% else %}
                               <a href="{% url 'public' %}?mode=list&detail_id={{ plainte.id }}" class="btn btn-sm btn-info me-1" title="Voir les d√©tails">
                                   <i class="bi bi-eye-fill"></i>
                               </a>
                               
                               {# Bouton MODIFIER (Mode form + plainte_id) #}
                               <a href="{% url 'public' %}?mode=form&plainte_id={{ plainte.id }}" class="btn btn-sm btn-success me-1" title="Modifier">
                                   <i class="bi bi-pencil-fill"></i>
                               </a>

                               {# Bouton SUPPRIMER (Formulaire POST pour Swal) #}
                               <form method="POST" action="{% url 'supprimer_plainte' plainte.id %}" class="d-inline form-delete">
                                   {% csrf_token %}
                                   <button type="submit" class="btn btn-sm btn-danger" title="Supprimer"> 
                                       <i class="bi bi-trash-fill"></i>
                                   </button>
                               </form>
                               {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="alert alert-info" role="alert">
                Vous n'avez pas encore d√©pos√© de plainte. Cliquez sur le bouton vert "Ametraka fitoriana vaovao" pour commencer.
            </div>
        {% endif %}

    {% endif %}

</div>

{% if request.session.plainte_success %}
        {% with success_data=request.session.plainte_success %}
        
        <div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-success text-white">
                        <h5 class="modal-title" id="successModalLabel">‚úÖ Plainte Envoy√©e avec Succ√®s !</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body text-center p-4">
                        <p class="lead">Votre plainte a √©t√© enregistr√©e sous le num√©ro :</p>
                        <h1 class="display-5 text-primary mb-4">
                            **{{ success_data.n_chrono_tkk }}**
                        </h1>

                        <div class="alert alert-info small" role="alert">
                            **Conservez ce QR Code pour le suivi de votre dossier.**
                            {% if success_data.mode_anonyme %}
                                <p class="mt-1 mb-0">√âtant donn√© que votre plainte est anonyme, le num√©ro de ticket est le **seul moyen** de la suivre.</p>
                            {% endif %}
                        </div>

                        <div class="qr-code-section my-3 p-3 rounded d-inline-block">
                            <h6 class="mb-2 text-muted">Votre Ticket de Suivi (QR Code)</h6>
                            <img src="data:image/png;base64,{{ success_data.qr_code_base64 }}" 
                                alt="QR Code de suivi de la plainte" 
                                class="img-fluid border p-1" 
                                style="max-width: 180px;">
                        </div>
                    </div>
                    <div class="modal-footer justify-content-center">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                        {% comment %} Optionnel : Lien de suivi si impl√©ment√© {% endcomment %}
                        {% comment %} <a href="{{ success_data.url_de_suivi }}" class="btn btn-primary">
                            Suivre ma plainte
                        </a> {% endcomment %}
                    </div>
                </div>
            </div>
        </div>

        <script>
            // Script pour afficher la modale au chargement de la page
            document.addEventListener('DOMContentLoaded', function () {
                var successModal = new bootstrap.Modal(document.getElementById('successModal'));
                successModal.show();
            });
        </script>
        {% endwith %}
        
        {% comment %} 
        IMPORTANT: Supprimer les donn√©es de la session imm√©diatement apr√®s le rendu
        pour que la modale n'apparaisse plus si l'utilisateur recharge la page.
        {% endcomment %}
      
        {% delete_session_key 'plainte_success' %}
{% endif %}
{% block extra_js %}
    {# --- 1. Inclusion de SweetAlert2 (√† placer dans votre base.html ou ici) --- #}
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    {# --- 2. Script JavaScript pour la confirmation de suppression (Swal) --- #}
    <script>
        $(document).ready(function() {
            
            // Cible tous les formulaires ayant la classe 'form-delete'
            $(document).on('submit', '.form-delete', function(e) {
                e.preventDefault(); 
                var form = this; 

                Swal.fire({
                    title: '√ätes-vous s√ªr ?',
                    text: "Cette plainte sera d√©finitivement supprim√©e ! Cette action est irr√©versible.",
                    icon: 'warning', 
                    showCancelButton: true, 
                    confirmButtonColor: '#d33', 
                    cancelButtonColor: '#3085d6', 
                    confirmButtonText: 'Oui, Supprimer !',
                    cancelButtonText: 'Annuler'
                }).then((result) => {
                    if (result.isConfirmed) {
                        
                        // Optionnel : Afficher un message de chargement pendant la soumission
                        Swal.fire({
                            title: 'Suppression en cours...',
                            text: 'Veuillez patienter.',
                            icon: 'info',
                            showConfirmButton: false,
                            willOpen: () => {
                                Swal.showLoading();
                            }
                        });

                        // Soumettre le formulaire r√©el au serveur
                        form.submit();
                    }
                });
            });
        });
    </script>


{% endblock extra_js %}
{% endblock content %}

