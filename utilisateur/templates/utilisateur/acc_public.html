{% extends "base.html" %}
{% load static %}
{% load my_custom_tags %}
{% block title %} PAC Public {% endblock title%}

{% block content %}
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="{% url 'public' %}"> <img src="{% static 'image/logo-pac.png'%}" width="50">PAC Public</a>
        
        <div class="ms-auto">
            <div class="dropdown">
                <a href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false" id="profileDropdown">
                   <img src="{% static 'image/profile.png'%}" width="50"> </a>

                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="profileDropdown">
                    <li class="px-3 py-2 text-wrap" style="max-width: 250px;">
                        <p class="mb-0 text-dark fw-bold">
                            {{ user.nom|default:"Utilisateur" }}
                        </p>
                        <small class="text-muted">
                            {{ user.email|default:"Email non disponible" }}
                        </small>
                    </li>
                    
                    <li><hr class="dropdown-divider"></li>
                    
                    <li>
                        <a class="dropdown-item text-danger" href="{% url 'logout' %}">
                            <i class="fas fa-sign-out-alt me-1"></i> Se DÃ©connecter
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</nav>

<div class="container mt-4">

    {# --- Messages de succÃ¨s/erreur Django --- #}
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} mt-3" role="alert">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}

    {# ======================================================= #}
    {# MODE FORMULAIRE (AJOUT / MODIFICATION) #}
    {# ======================================================= #}
    {% if mode == 'form' %}
        {% include "utilisateur/plainte.html" %}
    {% else %}
    
    {# ======================================================= #}
    {# MODE LISTE (LISTE / DÃ‰TAILS) #}
    {# ======================================================= #}
        
        <h2 class="mt-3">ðŸ‘‹ Tongasoa, {{ user.nom|default:"Utilisateur" }}!</h2>
        <hr>

        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3>ðŸ“‹ Liste des plaintes</h3>
            <a href="{% url 'public' %}?mode=form" class="btn btn-success btn-lg">
                <i class="bi bi-plus-circle-fill"></i> Ametraka fitoriana vaovao
            </a>
        </div>

        {# --- BLOC D'AFFICHAGE DES DÃ‰TAILS (NON TABULAIRE) --- #}
        {% if plainte_detail %}
           {% include "utilisateur/detail_plainte.html" %}
        {% endif %}
        {# --- FIN DU BLOC D'AFFICHAGE DES DÃ‰TAILS --- #}


        {% if plaintes %}
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>NÂ° Chrono TKK</th>
                            <th>Date</th>
                            <th>Auteur prÃ©sumÃ©</th>
                            <th>Statut</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for plainte in plaintes %}
                        <tr>
                            <td class="fw-bold">{{ plainte.n_chrono_tkk }}</td>
                            <td>{{ plainte.date_plainte|date:"d/m/Y" }}</td>
                            <td>{{ plainte.ilay_olona_kolikoly|truncatechars:50 }}</td>
                            <td>
                                {% if plainte.statut == 'ATTENTE' %}
                                    <span class="badge bg-warning text-dark">{{ plainte.get_statut_display }}</span>
                                {% elif plainte.statut == 'COURS' %}
                                    <span class="badge bg-info text-dark">{{ plainte.get_statut_display }}</span>
                                {% elif plainte.statut == 'TRAITEE' %}
                                    <span class="badge bg-success">{{ plainte.get_statut_display }}</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if plainte.statut == 'COURS' %}
                                {# Bouton DÃ‰TAILS (Mode liste + detail_id) #}
                               <a href="{% url 'public' %}?mode=list&detail_id={{ plainte.id }}" class="btn btn-sm btn-info me-1" title="Voir les dÃ©tails">
                                   <i class="bi bi-eye-fill"></i>
                               </a>
                               {% else %}
                               <a href="{% url 'public' %}?mode=list&detail_id={{ plainte.id }}" class="btn btn-sm btn-info me-1" title="Voir les dÃ©tails">
                                   <i class="bi bi-eye-fill"></i>
                               </a>
                               
                               {# Bouton MODIFIER (Mode form + plainte_id) #}
                               <a href="{% url 'public' %}?mode=form&plainte_id={{ plainte.id }}" class="btn btn-sm btn-success me-1" title="Modifier">
                                   <i class="bi bi-pencil-fill"></i>
                               </a>

                               {# Bouton SUPPRIMER (Formulaire POST pour Swal) #}
                               <form method="POST" action="{% url 'supprimer_plainte' plainte.id %}" class="d-inline form-delete">
                                   {% csrf_token %}
                                   <button type="submit" class="btn btn-sm btn-danger" title="Supprimer"> 
                                       <i class="bi bi-trash-fill"></i>
                                   </button>
                               </form>
                               {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="alert alert-info" role="alert">
                Vous n'avez pas encore dÃ©posÃ© de plainte. Cliquez sur le bouton vert "Ametraka fitoriana vaovao" pour commencer.
            </div>
        {% endif %}

    {% endif %}

</div>

{% if request.session.plainte_success %}
        {% with success_data=request.session.plainte_success %}
        {% include "qr.html" %}
        {% endwith %}
        {% delete_session_key 'plainte_success' %}
{% endif %}
{% block extra_js %}
    {# --- 1. Inclusion de SweetAlert2 (Ã  placer dans votre base.html ou ici) --- #}
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    {# --- 2. Script JavaScript pour la confirmation de suppression (Swal) --- #}
    <script>
        $(document).ready(function() {
            
            // Cible tous les formulaires ayant la classe 'form-delete'
            $(document).on('submit', '.form-delete', function(e) {
                e.preventDefault(); 
                var form = this; 

                Swal.fire({
                    title: 'ÃŠtes-vous sÃ»r ?',
                    text: "Cette plainte sera dÃ©finitivement supprimÃ©e ! Cette action est irrÃ©versible.",
                    icon: 'warning', 
                    showCancelButton: true, 
                    confirmButtonColor: '#d33', 
                    cancelButtonColor: '#3085d6', 
                    confirmButtonText: 'Oui, Supprimer !',
                    cancelButtonText: 'Annuler'
                }).then((result) => {
                    if (result.isConfirmed) {
                        
                        // Optionnel : Afficher un message de chargement pendant la soumission
                        Swal.fire({
                            title: 'Suppression en cours...',
                            text: 'Veuillez patienter.',
                            icon: 'info',
                            showConfirmButton: false,
                            willOpen: () => {
                                Swal.showLoading();
                            }
                        });

                        // Soumettre le formulaire rÃ©el au serveur
                        form.submit();
                    }
                });
            });
        });
    </script>


{% endblock extra_js %}
{% endblock content %}

