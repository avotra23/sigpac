{% extends "base.html" %}
{% load static %}
{% block title%}LOGIN PAC{% endblock title%}
{% block content %}
<style>
    body {
        /* Un dégradé élégant qui rappelle l'autorité et la confiance */
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0;
    }

    .wrapper {
        width: 100%;
        display: flex;
        justify-content: center;
        padding: 20px;
    }

    /* Optionnel : Ajout d'un effet de verre (Glassmorphism) sur la carte */
    .card-floating {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        box-shadow: 0 15px 35px rgba(0,0,0,0.2);
        overflow: hidden;
        border: 1px solid rgba(255,255,255,0.2);
    }
</style>


<div class="wrapper">
    <div class="card-floating">
        <div class="left-section">
            <div class="logo-circle">
                <img src="{% static 'image/logo-pac.png' %}" alt="logo-pac" class="logo-img">
            </div>
            <div class="subtitle">Pôles Anti-Corruption</div>
        </div>

        <div class="right-section">
            <h2>Se connecter</h2>

            <form id="loginForm" method="POST">
                {% csrf_token %}
                <div class="mb-3">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-control" placeholder="exemple@mail.com" name="email">
                </div>

                <div class="mb-2">
                    <label class="form-label">Mot de passe</label>
                    <div class="input-group">
                        <input type="password" id="password" class="form-control" placeholder="••••••••" name="password">
                        <button class="btn btn-toggle-password border-0" type="button">
                            <i class="bi bi-eye"></i>
                        </button>
                    </div>
                </div>

                <div class="text-end mb-3">
                    <a href="#" data-bs-toggle="modal" data-bs-target="#forgotPasswordModal" class="forgot">Mot de passe oublié ?</a>
                </div>

                <button type="submit" id="submitBtn" class="btn btn-login w-100">
                    Connexion
                </button>
            </form>

            <div class="signup-btn mt-3">
                Vous n'avez pas encore de compte ? 
                <a href="#" data-bs-toggle="modal" data-bs-target="#choix" style="text-decoration: none; font-weight: bold;">
                    Inscrivez-vous ici
                </a>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="choix" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Type d'inscription</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body d-flex flex-column gap-3">
                <a href="{% url 'utilisateur:inscriptionpub' %}" class="btn btn-outline-success w-100 py-2">
                    <i class="bi bi-person"></i> PUBLIC
                </a>
                <a href="{% url 'utilisateur:inscription_opj' %}" class="btn btn-outline-primary w-100 py-2">
                    <i class="bi bi-shield-lock"></i> OPJ
                </a>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="forgotPasswordModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header border-0 pb-0">
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body px-4 pb-4">
                <div class="text-center mb-4">
                    <div class="bg-light-primary rounded-circle d-inline-flex p-3 mb-2">
                        <i class="bi bi-person-badge fs-2 text-primary"></i>
                    </div>
                    <h5 class="fw-bold">Récupération Compte</h5>
                    <p class="text-muted small">Vérifiez vos informations pour changer votre mot de passe.</p>
                </div>
                
                <div class="form-floating mb-3">
                    <input type="email" id="resetEmail" class="form-control" placeholder="nom@mail.com">
                    <label><i class="bi bi-envelope me-2"></i>Email</label>
                </div>

                <div class="form-floating mb-3">
                    <input type="tel" id="resetTel" class="form-control" placeholder="0340000000">
                    <label><i class="bi bi-telephone me-2"></i>Numéro de téléphone</label>
                </div>

                <div class="mb-4">
                    <label class="form-label small fw-bold text-secondary">Nouveau mot de passe</label>
                    <div class="input-group">
                        <input type="password" id="resetNewPass" class="form-control border-end-0" placeholder="••••••••">
                        <button class="btn btn-outline-secondary border-start-0" type="button" onclick="togglePass()">
                            <i class="bi bi-eye" id="eyeIcon"></i>
                        </button>
                    </div>
                </div>

                <button type="button" id="btnReset" onclick="handleReset()" class="btn btn-primary w-100 py-2 fw-bold shadow-sm">
                    Confirmer le changement
                </button>
                
                <div id="resetStatus" class="mt-3 p-3 rounded-3 small d-none text-center animate__animated animate__fadeIn"></div>
            </div>
        </div>
    </div>
</div>
<div id="error-message" class="text-danger mt-2" style="display:none;"></div>
<<<<<<< HEAD
=======

<script src="{% static 'js/jquery-3.7.1.min.js'%} "></script>
<script src="{% static 'js/sweetalert211.js' %}"></script>
>>>>>>> 4995eca (Activation admin)
<script>
    function togglePass() {
    const p = document.getElementById('resetNewPass');
    const i = document.getElementById('eyeIcon');
    p.type = p.type === 'password' ? 'text' : 'password';
    i.classList.toggle('bi-eye');
    i.classList.toggle('bi-eye-slash');
}

function handleReset() {
    const email = document.getElementById('resetEmail').value;
    const telephone = document.getElementById('resetTel').value;
    const password = document.getElementById('resetNewPass').value;
    const statusDiv = document.getElementById('resetStatus');
    const btn = document.getElementById('btnReset');

    if(!email || !telephone || !password) {
        updateUI("Veuillez remplir tous les champs.", "alert-warning");
        return;
    }

    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

    fetch("{% url 'utilisateur:api_reset_password' %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': "{{ csrf_token }}"
        },
        body: JSON.stringify({ email: email, telephone: telephone, password: password })
    })
    .then(r => r.json().then(data => ({s: r.status, d: data})))
    .then(res => {
        if(res.s === 200) {
            updateUI(res.d.detail, "alert-success");
            setTimeout(() => location.reload(), 2000);
        } else {
            updateUI(res.d.detail, "alert-danger");
            btn.disabled = false;
            btn.innerText = "Confirmer le changement";
        }
    });
}

function updateUI(msg, colorClass) {
    const div = document.getElementById('resetStatus');
    div.innerText = msg;
    div.className = `mt-3 p-3 rounded-3 small text-center alert ${colorClass}`;
    div.classList.remove('d-none');
}
</script>
<script src="{% static 'js/bootstrap.bundle.min.js'%}"></script>
<script>
    const toggleBtn = document.querySelector('.btn-toggle-password');
    const password = document.querySelector('#password');

    toggleBtn.addEventListener('click', () => {
        const type = password.getAttribute('type') === 'password' ? 'text' : 'password';
        password.setAttribute('type', type);

        const icon = toggleBtn.querySelector('i');
        icon.classList.toggle('bi-eye');
        icon.classList.toggle('bi-eye-slash');
    });
</script>
<script>
    document.getElementById('loginForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const email = this.querySelector('[name="email"]').value;
    const password = this.querySelector('[name="password"]').value;
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]') ? 
                      document.querySelector('[name=csrfmiddlewaretoken]').value : "";

    fetch("{% url 'utilisateur:api_login' %}", {
        method: 'POST',
        headers: {
            'Accept': 'application/json',
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            email: email,
            password: password
        })
    })
    .then(response => response.json())
    .then(result => {
        if (result.role === 'public') {
            window.location.href = "{% url 'pac:public' %}";
        } else if (result.role === 'opj') {
            window.location.href = "{% url 'pac:opj' %}"; // Vérifiez le nom de l'URL (opj_list ?)
        } else if (result.role === 'dcn') {
            window.location.href = "{% url 'pac:dcn' %}";
        } else if (result.role === 'procureur') {
            window.location.href = "{% url 'pac:procureur' %}";
        } else if (result.role === 'greffier') {
            window.location.href = "{% url 'pac:greffier' %}";
        
        } else if (result.role === 'admin') {
            window.location.href = "{% url 'utilisateur:acc_admin' %}";
        } else {
            // Optionnel : gérer l'erreur de login (ex: mauvais mdp)
            if (result.detail) {
               
                 Swal.fire({
                    icon: 'Error',
                    title: 'Connexion error',
                    text: result.detail,
                    timer: 1000,
                    showConfirmButton: true
                });
            } else {
                 Swal.fire({
                    icon: 'Error',
                    title: 'Connexion error',
                    text: 'Erreur de connexion! Veuillez reessayez',
                    timer: 1000,
                    showConfirmButton: true
                });
            }
        }
    })
    .catch(error => {
        console.error("Erreur de connexion:", error);
    });
});
</script>
{% endblock content %}
