{%load static%}
<!DOCTYPE html>
<html lang="fr">
<head>
    
    <meta charset="UTF-8">
    <title>{% block title %}{% endblock title %}</title>
    <link rel="icon" type="image/png" href="{% static 'image/favicon.png' %}">
    
    <link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="{% static 'css/st.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/dataTables.dataTables.min.css' %}">
    <link rel="stylesheet" href="{% static 'css/dataTables.bootstrap5.min.css' %}">

</head>

<body>
   
   <div class="main-container {% if user.is_authenticated and groups and groups != 'opj' and groups != 'public' %}d-flex{% endif %}" style="width: 100%;">
    
    {% if user.is_authenticated and groups and groups != "opj" and groups != "public" %}
        <div class="sidebar" style="width: 220px; flex-shrink: 0;">
            {% include 'utilisateur/sidebar.html' %}
        </div>
    {% endif %}
    
    <div class="main-content {% if user.is_authenticated and groups and groups != 'opj' and groups != 'public' %}flex-grow-1{% endif %}">
        {% block content %}
        {% endblock content %}
    </div>
</div>

    

    {% if user.is_authenticated %}
       <div class="modal fade" id="profileModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Modifier mon profil</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <form id="profileUpdateForm" enctype="multipart/form-data">
                        <div class="modal-body">
                            <div class="text-center mb-3">
                                <img id="previewPhoto" src="{% if user.photo %}{{ user.photo.url }}{% else %}{% static 'image/profile.png' %}{% endif %}" 
                                    width="100" height="100" class="rounded-circle mb-2">
                                <input type="file" name="photo" class="form-control form-control-sm" accept="image/*" onchange="previewImage(this)">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Nom</label>
                                <input type="text" name="nom" class="form-control" value="{{ user.nom }}">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Prénom</label>
                                <input type="text" name="prenom" class="form-control" value="{{ user.prenom }}">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Téléphone</label>
                                <input type="text" name="telephone" class="form-control" value="{{ user.telephone|default:'' }}">
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                            <button type="submit" class="btn btn-primary">Enregistrer les modifications</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

    {% endif %}

<script>
    // Prévisualisation de l'image (doit être globale)
    function previewImage(input) {
        if (input.files && input.files[0]) {
            var reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('previewPhoto');
                if(preview) preview.src = e.target.result;
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    // On attend que le DOM soit chargé
    document.addEventListener("DOMContentLoaded", function() {
        const profileForm = document.getElementById('profileUpdateForm');

        // CONDITION CRUCIALE : On ne fait rien si le formulaire n'existe pas sur la page
        if (profileForm) {
            profileForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const formData = new FormData(this);
                const submitBtn = this.querySelector('button[type="submit"]');
                
                if(submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Chargement...';
                }

                fetch("{% url 'utilisateur:update_profil' %}", {  
                    method: 'POST', 
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'X-HTTP-Method-Override': 'PUT'
                    },
                    body: formData
                })
                .then(response => {
                    if (!response.ok) return response.json().then(err => { throw err; });
                    return response.json();
                })
                .then(data => {
                    Swal.fire({
                        icon: 'success',
                        title: 'Mis à jour !',
                        text: 'Votre profil a été modifié avec succès.',
                        timer: 1500,
                        showConfirmButton: false
                    }).then(() => {
                        location.reload(); 
                    });
                })
                .catch(error => {
                    console.error('Erreur:', error);
                    let errorMsg = "Une erreur est survenue.";
                    if (typeof error === 'object') {
                        errorMsg = Object.values(error).flat().join("<br>");
                    }
                    Swal.fire('Erreur', errorMsg, 'error');
                })
                .finally(() => {
                    if(submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = 'Mettre à jour le profil';
                    }
                });
            });
        }
    });
</script>
<script src="{% static 'js/bootstrap.bundle.min.js' %}"></script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        // 1. On cherche tous les inputs, textareas et selects qui ont l'attribut 'required'
        const requiredInputs = document.querySelectorAll('input[required], textarea[required], select[required]');

        requiredInputs.forEach(input => {
            // 2. On cherche le label associé via l'attribut 'for'
            const label = document.querySelector(`label[for="${input.id}"]`);
            
            if (label) {
                // 3. On crée l'élément étoile
                const star = document.createElement('span');
                star.innerHTML = ' *';
                star.style.color = 'red';
                star.style.fontWeight = 'bold';
                
                // 4. On l'ajoute à la fin du texte du label
                label.appendChild(star);
            }
        });
    });
</script>
{% block extra_js %}{% endblock %}
</body>
</html>